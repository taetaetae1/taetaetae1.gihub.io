
<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="꿈꾸는 태태태의 공간">
    <title>Spring에서 Request를 우아하게 로깅하기 - 꿈꾸는 태태태의 공간</title>
    <meta name="author" content="taetaetae">
    
    
    
        <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"taetaetae","sameAs":["https://facebook.com/taetaetae0","https://www.linkedin.com/in/태관-권-517825129/","mailto:taetaetae_@naver.com"],"image":"profile.jpg"},"articleBody":"스프링 기반의 웹 어플리케이션을 만들다 보면 요청을 처리하는데 맨 처음에 위치하고 있는 Controller(이하 컨트롤러)라는 레이어를 만들게 된다. 그럴때면 사용자가 어떤 요청(Request)을 하였는지에 대해 확인이 필요할 수 있다.  물론 확인을 안해도 무방하지만 가급적 로깅은 시스템 로직에 영향을 주지 않는 범위에서 최대한 다양하게 미리 해두는게 나중에 유지보수시 편할 수 있다. (예전 조직장님께서 말씀하신게 아직도 머릿속에 꽉 자리잡고 있다…)아~주 일반적으로, 컨트롤러에서는 다음과 같이 메소드 단위로 파라미터를 직접 로깅하게 된다.12345678910@Slf4j@RestControllerpublic class SampleController &#123;\t@GetMapping(\"/test1\")\tpublic String test1(@RequestParam String id) &#123;\t\tlog.info(\"id : &#123;&#125;\", id);\t\treturn \"length : \" + id.length();\t&#125;&#125;\n이렇게 되면 사용자가 GET /test1 이라는 요청을 보낼때 어떤 파라미터로 호출하였는지에 대해 로깅이 남게 되는데 항상 log.info(&quot;id : {}&quot;, id); 과 같이 수동으로 로깅을 남겨야 하는 불편함이 생긴다. 물론 꼼꼼하게 메소드마다 로깅을 적어주면 전혀 문제될게 없지만 이러한 컨트롤러 ~ 메소드가 한두개가 아닌 수십 또는 수백개일 경우엔 그때마다 로깅을 적어줘야 하는 불편함이 있을 수 있다. 또한 자칫 깜박하고 로깅을 빼먹고 배포를 하게 된 경우 모니터링시 로깅을 하지 않아서 다시 로깅하고 배포를 하는, 별것도 아닌데(?) “정말 불편한” 상황이 있을 수 있다.이번 포스팅에서는 사용자의 요청을 모니터링 하기 위해 컨트롤러마다 코드를 작성해가며 로깅을 하는것이 아니라 HttpServletRequestWrapper 라는 것과 Filter, AOP를 이용하여 Request의 정보를 한곳에서 우아하게 로깅하는 방법에 대해 알아보고자 한다.\n# 요구사항와 개발하자아!출처 : https://gfycat.com/ko/brightevilaoudad와 개발하자아!출처 : https://gfycat.com/ko/brightevilaoudad\n투우사가 흔드는 빨간 천을 보며 돌진하는 황소처럼 (쓰고보니 너무 TMI 같다….) 당장 코딩을 시작하며 개발을 할 수도 있지만 정작 원하는 기능이 무엇인지 천천히 정리하고 넘어갈 필요가 있는 것 같다. (어쩔땐 오히려 후자가 더 빠른 개발을 하게 되는것 같다.)\n\nGET, POST 등 다양한 http method 로 구현된 모든 컨트롤러의 파라미터와 기타 Request 정보가 로깅이 되야 한다.\n컨트롤러, 메소드가 늘어날때마다 별도의 코드 추가 없이 한곳에서 공통적으로 로깅이 되야 한다.\nURL 중 특정 패턴으로 들어오는 요청은 다른 방식으로 로깅을 하거나, 로깅에서 제외할 수 있어야 한다.\n앞서 말했듯 다른 비지니스 로직에 영향을 주지 않아야 한다.\n\n# 구현하기 - Request 의 파라미터 정리Request 의 모든 로깅을 한곳에서 처리하기 위해서 filter(필터)를 활용하였다. 필터는 Dispatcher servlet의 앞단에 위치하고 있기 때문에 모든 정보를 확인할 수 있는데 용이하다. 물론 인터셉터를 활용해서도 방법이 있겠지만 본 포스팅 에서는 필터를 활용해서 구현하는것을 목적으로 한다. (사실 인터셉터로 몇번 시도해보다가 실패해서…유유 )\nSpring MVC Request Life Cycle출처 : https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/Spring MVC Request Life Cycle출처 : https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/\nFilter를 만들기 전에 Filter에서 사용할 주요 핵심(?) 클래스가 필요한데 HttpServletRequest 를 Wrapping 해서 사용하기 위해 HttpServletRequestWrapper를 상속받는 클래스를 만들자. Request 에 담겨있는 param 과 body로 요청이 들어올 경우 body에 있는 내용을 param 에 담는 로직이다. 주요 설명은 코드 안에서 주석으로 설명하겠다.123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115public class ReadableRequestWrapper extends HttpServletRequestWrapper &#123; // 상속\tprivate final Charset encoding;\tprivate byte[] rawData;\tprivate Map&lt;String, String[]&gt; params = new HashMap&lt;&gt;();\tpublic ReadableRequestWrapper(HttpServletRequest request) &#123;\t\tsuper(request);\t\tthis.params.putAll(request.getParameterMap()); // 원래의 파라미터를 저장\t\tString charEncoding = request.getCharacterEncoding(); // 인코딩 설정\t\tthis.encoding = StringUtils.isBlank(charEncoding) ? StandardCharsets.UTF_8 : Charset.forName(charEncoding);\t\ttry &#123;\t\t\tInputStream is = request.getInputStream();\t\t\tthis.rawData = IOUtils.toByteArray(is); // InputStream 을 별도로 저장한 다음 getReader() 에서 새 스트림으로 생성\t\t\t// body 파싱\t\t\tString collect = this.getReader().lines().collect(Collectors.joining(System.lineSeparator()));\t\t\tif (StringUtils.isEmpty(collect)) &#123; // body 가 없을경우 로깅 제외\t\t\t\treturn;\t\t\t&#125;\t\t\tif (request.getContentType() != null &amp;&amp; request.getContentType().contains(\t\t\t\tContentType.MULTIPART_FORM_DATA.getMimeType())) &#123; // 파일 업로드시 로깅제외\t\t\t\treturn;\t\t\t&#125;\t\t\tJSONParser jsonParser = new JSONParser();\t\t\tObject parse = jsonParser.parse(collect);\t\t\tif (parse instanceof JSONArray) &#123;\t\t\t\tJSONArray jsonArray = (JSONArray)jsonParser.parse(collect);\t\t\t\tsetParameter(\"requestBody\", jsonArray.toJSONString());\t\t\t&#125; else &#123;\t\t\t\tJSONObject jsonObject = (JSONObject)jsonParser.parse(collect);\t\t\t\tIterator iterator = jsonObject.keySet().iterator();\t\t\t\twhile (iterator.hasNext()) &#123;\t\t\t\t\tString key = (String)iterator.next();\t\t\t\t\tsetParameter(key, jsonObject.get(key).toString().replace(\"\\\"\", \"\\\\\\\"\"));\t\t\t\t&#125;\t\t\t&#125;\t\t&#125; catch (Exception e) &#123;\t\t\tlog.error(\"ReadableRequestWrapper init error\", e);\t\t&#125;\t&#125;\t@Override\tpublic String getParameter(String name) &#123;\t\tString[] paramArray = getParameterValues(name);\t\tif (paramArray != null &amp;&amp; paramArray.length &gt; 0) &#123;\t\t\treturn paramArray[0];\t\t&#125; else &#123;\t\t\treturn null;\t\t&#125;\t&#125;\t@Override\tpublic Map&lt;String, String[]&gt; getParameterMap() &#123;\t\treturn Collections.unmodifiableMap(params);\t&#125;\t@Override\tpublic Enumeration&lt;String&gt; getParameterNames() &#123;\t\treturn Collections.enumeration(params.keySet());\t&#125;\t@Override\tpublic String[] getParameterValues(String name) &#123;\t\tString[] result = null;\t\tString[] dummyParamValue = params.get(name);\t\tif (dummyParamValue != null) &#123;\t\t\tresult = new String[dummyParamValue.length];\t\t\tSystem.arraycopy(dummyParamValue, 0, result, 0, dummyParamValue.length);\t\t&#125;\t\treturn result;\t&#125;\tpublic void setParameter(String name, String value) &#123;\t\tString[] param = &#123;value&#125;;\t\tsetParameter(name, param);\t&#125;\tpublic void setParameter(String name, String[] values) &#123;\t\tparams.put(name, values);\t&#125;\t@Override\tpublic ServletInputStream getInputStream() &#123;\t\tfinal ByteArrayInputStream byteArrayInputStream = new ByteArrayInputStream(this.rawData);\t\treturn new ServletInputStream() &#123;\t\t\t@Override\t\t\tpublic boolean isFinished() &#123;\t\t\t\treturn false;\t\t\t&#125;\t\t\t@Override\t\t\tpublic boolean isReady() &#123;\t\t\t\treturn false;\t\t\t&#125;\t\t\t@Override\t\t\tpublic void setReadListener(ReadListener readListener) &#123;\t\t\t\t// Do nothing\t\t\t&#125;\t\t\tpublic int read() &#123;\t\t\t\treturn byteArrayInputStream.read();\t\t\t&#125;\t\t&#125;;\t&#125;\t@Override\tpublic BufferedReader getReader() &#123;\t\treturn new BufferedReader(new InputStreamReader(this.getInputStream(), this.encoding));\t&#125;&#125;\n가장 중요한 부분은 IOUtils.toByteArray(is) 요 부분인데, InputStream은 한번밖에 읽을 수 없기 때문에 이 필터에서 스트림을 읽는 대신, 래퍼 구현으로 새 스트림 생성하도록 작업을 하였다. 자칫 잘못하다간 body의 내용이 유실될 수도 있기 때문이다.참조 :http://stackoverflow.com/questions/10210645/http-servlet-request-lose-params-from-post-body-after-read-it-oncehttp://stackoverflow.com/questions/3769259/why-is-the-parameter-value-an-object-hash-code-for-request-getparametermap-ge\n위에서 만든 래퍼 클래스를 이제 필터에서 적용해보자.123456789101112131415161718public class ReadableRequestWrapperFilter implements Filter &#123;\t@Override\tpublic void init(FilterConfig filterConfig) &#123;\t\t// Do nothing\t&#125;\t@Override\tpublic void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\t\tthrows IOException, ServletException &#123;\t\tReadableRequestWrapper wrapper = new ReadableRequestWrapper((HttpServletRequest)request);\t\tchain.doFilter(wrapper, response);\t&#125;\t@Override\tpublic void destroy() &#123;\t\t// Do nothing\t&#125;&#125;\n이렇게 되면 param으로 넘어온 파라미터나 body로 넘어온 정보들이 파싱되어 param에 담기게 된다.(JSON으로 파싱하는 부분은 조금 지저분해 보일 수 있지만 다양한 테스트를 해보면서 얻은 결과물이다. 더 좋은 방식이 있다면 언제든지 PullRequest 또는 댓글 환영!)\n# 구현하기 - 컨트롤러에 AOP 셋팅이제 Request 의 params 를 한곳에서 로깅할 차례이다. 물론 위에서 만든 필터에서 로깅을 해도 되지만 필터에 로직이 들어가는 것보다 별도의 로직에서 처리하는게 맞다고 생각되어 분리를 하였다. (관심사의 분리)AOP를 활용하여 다음과 같이 로직을 작성하였다. 아래 로직은 이해하기에 큰 어려움은 없을것 같지만 주석으로 설명을 하겠다.123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354@Component@Aspect@Slf4jpublic class LoggerAspect &#123;\t@Pointcut(\"execution(* com.taetaetae..*Controller.*(..))\") // 이런 패턴이 실행될 경우 수행\tpublic void loggerPointCut() &#123;\t&#125;\t@Around(\"loggerPointCut()\")\tpublic Object methodLogger(ProceedingJoinPoint proceedingJoinPoint) throws Throwable &#123;\t\ttry &#123;\t\t\tObject result = proceedingJoinPoint.proceed();\t\t\tHttpServletRequest request = ((ServletRequestAttributes)RequestContextHolder.getRequestAttributes()).getRequest(); // request 정보를 가져온다.\t\t\tString controllerName = proceedingJoinPoint.getSignature().getDeclaringType().getSimpleName();\t\t\tString methodName = proceedingJoinPoint.getSignature().getName();\t\t\tMap&lt;String, Object&gt; params = new HashMap&lt;&gt;();\t\t\ttry &#123;\t\t\t\tparams.put(\"controller\", controllerName);\t\t\t\tparams.put(\"method\", methodName);\t\t\t\tparams.put(\"params\", getParams(request));\t\t\t\tparams.put(\"log_time\", new Date());\t\t\t\tparams.put(\"request_uri\", request.getRequestURI());\t\t\t\tparams.put(\"http_method\", request.getMethod());\t\t\t&#125; catch (Exception e) &#123;\t\t\t\tlog.error(\"LoggerAspect error\", e);\t\t\t&#125;\t\t\tlog.info(\"params : &#123;&#125;\", params); // param에 담긴 정보들을 한번에 로깅한다.\t\t\treturn result;\t\t&#125; catch (Throwable throwable) &#123;\t\t\tthrow throwable;\t\t&#125;\t&#125;\t/**\t * request 에 담긴 정보를 JSONObject 형태로 반환한다.\t * @param request\t * @return\t */\tprivate static JSONObject getParams(HttpServletRequest request) &#123;\t\tJSONObject jsonObject = new JSONObject();\t\tEnumeration&lt;String&gt; params = request.getParameterNames();\t\twhile (params.hasMoreElements()) &#123;\t\t\tString param = params.nextElement();\t\t\tString replaceParam = param.replaceAll(\"\\\\.\", \"-\");\t\t\tjsonObject.put(replaceParam, request.getParameter(param));\t\t&#125;\t\treturn jsonObject;\t&#125;&#125;\n위 코드에서는 단순히 console log를 찍었지만 필자가 운영하고 있는 어드민 툴에서는 Request 정보를 Elasticsearch 에 인덱싱하고 이를 키바나에서 보다 쉽게 조회 및 모니터링이 가능하도록 구현하였다. 로깅을 어떤식으로 남길지, 로깅이 아닌 특정 상황에서 알림을 보낸다거나 등등 이 부분은 실제 구현시에 상황에 맞춰서 만들면 될 것 같다.또한 Pointcut 부분을 다르게 활용하여 위에서 이야기한 요구사항의 3번 (URL 중 특정 패턴으로 들어오는 요청은 다른 방식으로 로깅을 하거나, 로깅에서 제외할 수 있어야 한다.) 를 해결할 수 있다.아참, AOP의 개념을 좀더 알고 싶다면 jojoldu 님의 블로그 포스팅을 추천한다. https://jojoldu.tistory.com/71\n그래서 아래처럼 테스트를 해보면 GET 이던 POST 이던 로깅이 되는것을 확인할수 있다.더 이쁘게 로깅을 하는건 자유!더 이쁘게 로깅을 하는건 자유!\n# 마치며사실 이 로직을 만들게 된 계기는 팀원중에 한분이 “GET 의 파라미터는 로깅이 되는데 POST 의 파라미터는 로깅이 안되요” 라는 말에 투우사 앞에 있는 황소마냥 찾아보다 만들게 되었다. 참고로 이 부분은 하나의 무기가 될것 같아 github에 공개를 하였고 위에서 적었던 요구사항보다 더 좋은 내용이 있다면 언제든지 PullRequest 를 날려주기를 바란다. Spring Boot 환경에서 Filter를 추가하며 구성하였다.https://github.com/taetaetae/request_logging필터와 인터셉터, AOP 등 평소 자주 사용하지 않은 (이미 누군가 다 만들어 둔) 부분을 만지면서 다시한번 Spring의 주요 개념을 숙지하는데 도움이 되었던 경험으로 남을 것 같다.\n","dateCreated":"2019-06-30T18:39:47+09:00","dateModified":"2020-04-23T13:41:36+09:00","datePublished":"2019-06-30T18:39:47+09:00","description":"스프링 기반의 웹 어플리케이션을 만들다 보면 요청을 처리하는데 맨 처음에 위치하고 있는 Controller(이하 컨트롤러)라는 레이어를 만들게 된다. 그럴때면 사용자가 어떤 요청(Request)을 하였는지에 대해 확인이 필요할 수 있다.","headline":"Spring에서 Request를 우아하게 로깅하기","image":["spring_boot_logging.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://taetaetae.github.io/2019/06/30/controller-common-logging/"},"publisher":{"@type":"Organization","name":"taetaetae","sameAs":["https://facebook.com/taetaetae0","https://www.linkedin.com/in/태관-권-517825129/","mailto:taetaetae_@naver.com"],"image":"profile.jpg","logo":{"@type":"ImageObject","url":"profile.jpg"}},"url":"https://taetaetae.github.io/2019/06/30/controller-common-logging/","keywords":"spring, logging, HttpServletRequestWrapper, Filter, AOP","thumbnailUrl":"spring_boot_logging.png"}</script>
    <meta name="description" content="스프링 기반의 웹 어플리케이션을 만들다 보면 요청을 처리하는데 맨 처음에 위치하고 있는 Controller(이하 컨트롤러)라는 레이어를 만들게 된다. 그럴때면 사용자가 어떤 요청(Request)을 하였는지에 대해 확인이 필요할 수 있다.">
<meta name="keywords" content="spring,logging,HttpServletRequestWrapper,Filter,AOP">
<meta property="og:type" content="blog">
<meta property="og:title" content="Spring에서 Request를 우아하게 로깅하기">
<meta property="og:url" content="https://taetaetae.github.io/2019/06/30/controller-common-logging/index.html">
<meta property="og:site_name" content="꿈꾸는 태태태의 공간">
<meta property="og:description" content="스프링 기반의 웹 어플리케이션을 만들다 보면 요청을 처리하는데 맨 처음에 위치하고 있는 Controller(이하 컨트롤러)라는 레이어를 만들게 된다. 그럴때면 사용자가 어떤 요청(Request)을 하였는지에 대해 확인이 필요할 수 있다.">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2020-04-23T04:41:36.700Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring에서 Request를 우아하게 로깅하기">
<meta name="twitter:description" content="스프링 기반의 웹 어플리케이션을 만들다 보면 요청을 처리하는데 맨 처음에 위치하고 있는 Controller(이하 컨트롤러)라는 레이어를 만들게 된다. 그럴때면 사용자가 어떤 요청(Request)을 하였는지에 대해 확인이 필요할 수 있다.">
<meta name="twitter:image" content="https://taetaetae.github.io/2019/06/30/controller-common-logging/bull_fighting.gif">
    
    
        
    
    
    
        <meta property="og:image" content="https://taetaetae.github.io/2019/06/30/controller-common-logging/spring_boot_logging.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://taetaetae.github.io/2019/06/30/controller-common-logging/spring_boot_logging.png" />
    
    
    
        <meta property="og:image" content="https://taetaetae.github.io/assets/images/profile.jpg"/>
    

    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/all.css">
    <link rel="stylesheet" href="/assets/css/jquery.fancybox.css">
    <link rel="stylesheet" href="/assets/css/thumbs.css">
    <link rel="stylesheet" href="/assets/css/tranquilpeak.css">
    <!--STYLES END-->
    
    <script type="text/javascript">
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-86432198-1', 'auto');
        ga('send', 'pageview');
    </script>


    
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: "ca-pub-5788330009690816",
  enable_page_level_ads: true
  });
</script>
</head>

    <body>
        <div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="5">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a class="header-title-link" href="/ ">꿈꾸는 태태태의 공간</a>
    </div>
    
        
            <a  class="header-right-picture "
                href="#about">
        
        
            <img class="header-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="5">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a href="/#about">
                    <img class="sidebar-profile-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture"/>
                </a>
                <h4 class="sidebar-profile-name">taetaetae</h4>
                
                    <h5 class="sidebar-profile-bio"><p>Programmer</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/ "
                            
                            title="Home"
                        >
                    
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Home</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-categories"
                            
                            title="Categories"
                        >
                    
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Categories</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-tags"
                            
                            title="Tags"
                        >
                    
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Tags</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/all-archives"
                            
                            title="Archives"
                        >
                    
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Archives</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="#about"
                            
                            title="About"
                        >
                    
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">About</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://facebook.com/taetaetae0" target="_blank" rel="noopener" title="Facebook">
                    
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="https://www.linkedin.com/in/태관-권-517825129/" target="_blank" rel="noopener" title="LinkedIn">
                    
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link " href="mailto:taetaetae_@naver.com" target="_blank" rel="noopener" title="Mail">
                    
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Mail</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a  class="sidebar-button-link "
                             href="/atom.xml"
                            
                            title="RSS"
                        >
                    
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
        </ul>
        
    </div>    
    <ins class="adsbygoogle"
   style="display:inline-block;max-width:250px;width:100%;max-height:380px;height:100%"
   data-ad-client="ca-pub-5788330009690816">
</ins>
<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
</nav>

            
            <div id="main" data-behavior="5"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    <div class="main-content-wrap">
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5788330009690816"
     data-ad-slot="9180895229"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
    </div>
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Spring에서 Request를 우아하게 로깅하기
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2019-06-30T18:39:47+09:00">
	
		    Jun 30, 2019
    	
    </time>
    
        <span>in </span>
        
    <a class="category-link" href="/categories/tech/">tech</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <p>스프링 기반의 웹 어플리케이션을 만들다 보면 요청을 처리하는데 맨 처음에 위치하고 있는 <code>Controller</code>(이하 컨트롤러)라는 레이어를 만들게 된다. 그럴때면 사용자가 어떤 요청(Request)을 하였는지에 대해 확인이 필요할 수 있다. <a id="more"></a> 물론 확인을 안해도 무방하지만 가급적 로깅은 시스템 로직에 영향을 주지 않는 범위에서 최대한 다양하게 <code>미리</code> 해두는게 나중에 유지보수시 편할 수 있다. (예전 조직장님께서 말씀하신게 아직도 머릿속에 꽉 자리잡고 있다…)<br>아~주 일반적으로, 컨트롤러에서는 다음과 같이 메소드 단위로 파라미터를 직접 로깅하게 된다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@GetMapping</span>(<span class="string">"/test1"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">test1</span><span class="params">(@RequestParam String id)</span> </span>&#123;</span><br><span class="line">		log.info(<span class="string">"id : &#123;&#125;"</span>, id);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"length : "</span> + id.length();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>이렇게 되면 사용자가 <code>GET /test1</code> 이라는 요청을 보낼때 어떤 파라미터로 호출하였는지에 대해 로깅이 남게 되는데 항상 <code>log.info(&quot;id : {}&quot;, id);</code> 과 같이 수동으로 로깅을 남겨야 하는 불편함이 생긴다. 물론 꼼꼼하게 메소드마다 로깅을 적어주면 전혀 문제될게 없지만 이러한 컨트롤러 ~ 메소드가 한두개가 아닌 수십 또는 수백개일 경우엔 그때마다 로깅을 적어줘야 하는 불편함이 있을 수 있다. 또한 자칫 깜박하고 로깅을 빼먹고 배포를 하게 된 경우 모니터링시 로깅을 하지 않아서 다시 로깅하고 배포를 하는, 별것도 아닌데(?) “정말 불편한” 상황이 있을 수 있다.<br>이번 포스팅에서는 사용자의 요청을 모니터링 하기 위해 컨트롤러마다 코드를 작성해가며 로깅을 하는것이 아니라 <code>HttpServletRequestWrapper</code> 라는 것과 <code>Filter</code>, <code>AOP</code>를 이용하여 <strong>Request의 정보를 한곳에서 우아하게 로깅하는 방법</strong>에 대해 알아보고자 한다.</p>
<h3 id="요구사항"><a href="#요구사항" class="headerlink" title="# 요구사항"></a># 요구사항</h3><div class="figure center" style="width:;"><a class="fancybox" href="bull_fighting.gif" title="와 개발하자아!<br>출처 : https://gfycat.com/ko/brightevilaoudad" data-caption="와 개발하자아!<br>출처 : https://gfycat.com/ko/brightevilaoudad" data-fancybox="default"><img class="fig-img" src="bull_fighting.gif" alt="와 개발하자아!<br>출처 : https://gfycat.com/ko/brightevilaoudad"><span class="image-caption">와 개발하자아!<br>출처 : https://gfycat.com/ko/brightevilaoudad</span></a><span class="caption">와 개발하자아!<br>출처 : https://gfycat.com/ko/brightevilaoudad</span></div><div style="clear:both;"></div>
<p>투우사가 흔드는 빨간 천을 보며 돌진하는 황소처럼 (쓰고보니 너무 TMI 같다….) 당장 코딩을 시작하며 개발을 할 수도 있지만 정작 원하는 기능이 무엇인지 천천히 정리하고 넘어갈 필요가 있는 것 같다. (어쩔땐 오히려 후자가 더 빠른 개발을 하게 되는것 같다.)</p>
<ol>
<li>GET, POST 등 다양한 http method 로 구현된 모든 컨트롤러의 파라미터와 기타 Request 정보가 로깅이 되야 한다.</li>
<li>컨트롤러, 메소드가 늘어날때마다 별도의 코드 추가 없이 한곳에서 공통적으로 로깅이 되야 한다.</li>
<li>URL 중 특정 패턴으로 들어오는 요청은 다른 방식으로 로깅을 하거나, 로깅에서 제외할 수 있어야 한다.</li>
<li>앞서 말했듯 다른 비지니스 로직에 영향을 주지 않아야 한다.</li>
</ol>
<h3 id="구현하기-Request-의-파라미터-정리"><a href="#구현하기-Request-의-파라미터-정리" class="headerlink" title="# 구현하기 - Request 의 파라미터 정리"></a># 구현하기 - Request 의 파라미터 정리</h3><p>Request 의 모든 로깅을 한곳에서 처리하기 위해서 filter(필터)를 활용하였다. 필터는 Dispatcher servlet의 앞단에 위치하고 있기 때문에 모든 정보를 확인할 수 있는데 용이하다. 물론 인터셉터를 활용해서도 방법이 있겠지만 본 포스팅 에서는 필터를 활용해서 구현하는것을 목적으로 한다. (사실 인터셉터로 몇번 시도해보다가 실패해서…유유 )</p>
<div class="figure center" style="width:;"><a class="fancybox" href="spring-request-lifecycle.jpg" title="Spring MVC Request Life Cycle<br>출처 : https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/" data-caption="Spring MVC Request Life Cycle<br>출처 : https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/" data-fancybox="default"><img class="fig-img" src="spring-request-lifecycle.jpg" alt="Spring MVC Request Life Cycle<br>출처 : https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/"><span class="image-caption">Spring MVC Request Life Cycle<br>출처 : https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/</span></a><span class="caption">Spring MVC Request Life Cycle<br>출처 : https://justforchangesake.wordpress.com/2014/05/07/spring-mvc-request-life-cycle/</span></div><div style="clear:both;"></div>
<p>Filter를 만들기 전에 Filter에서 사용할 주요 핵심(?) 클래스가 필요한데 <code>HttpServletRequest</code> 를 Wrapping 해서 사용하기 위해 <code>HttpServletRequestWrapper</code>를 상속받는 클래스를 만들자. Request 에 담겨있는 param 과 body로 요청이 들어올 경우 body에 있는 내용을 param 에 담는 로직이다. 주요 설명은 코드 안에서 주석으로 설명하겠다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadableRequestWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123; <span class="comment">// 상속</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Charset encoding;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">byte</span>[] rawData;</span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String[]&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ReadableRequestWrapper</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(request);</span><br><span class="line">		<span class="keyword">this</span>.params.putAll(request.getParameterMap()); <span class="comment">// 원래의 파라미터를 저장</span></span><br><span class="line"></span><br><span class="line">		String charEncoding = request.getCharacterEncoding(); <span class="comment">// 인코딩 설정</span></span><br><span class="line">		<span class="keyword">this</span>.encoding = StringUtils.isBlank(charEncoding) ? StandardCharsets.UTF_8 : Charset.forName(charEncoding);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			InputStream is = request.getInputStream();</span><br><span class="line">			<span class="keyword">this</span>.rawData = IOUtils.toByteArray(is); <span class="comment">// InputStream 을 별도로 저장한 다음 getReader() 에서 새 스트림으로 생성</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">// body 파싱</span></span><br><span class="line">			String collect = <span class="keyword">this</span>.getReader().lines().collect(Collectors.joining(System.lineSeparator()));</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.isEmpty(collect)) &#123; <span class="comment">// body 가 없을경우 로깅 제외</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (request.getContentType() != <span class="keyword">null</span> &amp;&amp; request.getContentType().contains(</span><br><span class="line">				ContentType.MULTIPART_FORM_DATA.getMimeType())) &#123; <span class="comment">// 파일 업로드시 로깅제외</span></span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			JSONParser jsonParser = <span class="keyword">new</span> JSONParser();</span><br><span class="line">			Object parse = jsonParser.parse(collect);</span><br><span class="line">			<span class="keyword">if</span> (parse <span class="keyword">instanceof</span> JSONArray) &#123;</span><br><span class="line">				JSONArray jsonArray = (JSONArray)jsonParser.parse(collect);</span><br><span class="line">				setParameter(<span class="string">"requestBody"</span>, jsonArray.toJSONString());</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				JSONObject jsonObject = (JSONObject)jsonParser.parse(collect);</span><br><span class="line">				Iterator iterator = jsonObject.keySet().iterator();</span><br><span class="line">				<span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">					String key = (String)iterator.next();</span><br><span class="line">					setParameter(key, jsonObject.get(key).toString().replace(<span class="string">"\""</span>, <span class="string">"\\\""</span>));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			log.error(<span class="string">"ReadableRequestWrapper init error"</span>, e);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getParameter</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		String[] paramArray = getParameterValues(name);</span><br><span class="line">		<span class="keyword">if</span> (paramArray != <span class="keyword">null</span> &amp;&amp; paramArray.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> paramArray[<span class="number">0</span>];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> Map&lt;String, String[]&gt; getParameterMap() &#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.unmodifiableMap(params);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getParameterNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Collections.enumeration(params.keySet());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String[] getParameterValues(String name) &#123;</span><br><span class="line">		String[] result = <span class="keyword">null</span>;</span><br><span class="line">		String[] dummyParamValue = params.get(name);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (dummyParamValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">			result = <span class="keyword">new</span> String[dummyParamValue.length];</span><br><span class="line">			System.arraycopy(dummyParamValue, <span class="number">0</span>, result, <span class="number">0</span>, dummyParamValue.length);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(String name, String value)</span> </span>&#123;</span><br><span class="line">		String[] param = &#123;value&#125;;</span><br><span class="line">		setParameter(name, param);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setParameter</span><span class="params">(String name, String[] values)</span> </span>&#123;</span><br><span class="line">		params.put(name, values);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">final</span> ByteArrayInputStream byteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(<span class="keyword">this</span>.rawData);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener readListener)</span> </span>&#123;</span><br><span class="line">				<span class="comment">// Do nothing</span></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> byteArrayInputStream.read();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(<span class="keyword">this</span>.getInputStream(), <span class="keyword">this</span>.encoding));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>가장 중요한 부분은 <code>IOUtils.toByteArray(is)</code> 요 부분인데, InputStream은 한번밖에 읽을 수 없기 때문에 이 필터에서 스트림을 읽는 대신, 래퍼 구현으로 새 스트림 생성하도록 작업을 하였다. 자칫 잘못하다간 body의 내용이 유실될 수도 있기 때문이다.<br>참조 :<br><a href="http://stackoverflow.com/questions/10210645/http-servlet-request-lose-params-from-post-body-after-read-it-once" target="_blank" rel="noopener">http://stackoverflow.com/questions/10210645/http-servlet-request-lose-params-from-post-body-after-read-it-once</a><br><a href="http://stackoverflow.com/questions/3769259/why-is-the-parameter-value-an-object-hash-code-for-request-getparametermap-ge" target="_blank" rel="noopener">http://stackoverflow.com/questions/3769259/why-is-the-parameter-value-an-object-hash-code-for-request-getparametermap-ge</a></p>
<p>위에서 만든 래퍼 클래스를 이제 필터에서 적용해보자.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadableRequestWrapperFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Do nothing</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></span><br><span class="line"><span class="function">		<span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">		ReadableRequestWrapper wrapper = <span class="keyword">new</span> ReadableRequestWrapper((HttpServletRequest)request);</span><br><span class="line">		chain.doFilter(wrapper, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="comment">// Do nothing</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>이렇게 되면 param으로 넘어온 파라미터나 body로 넘어온 정보들이 파싱되어 param에 담기게 된다.<br>(JSON으로 파싱하는 부분은 조금 지저분해 보일 수 있지만 다양한 테스트를 해보면서 얻은 결과물이다. 더 좋은 방식이 있다면 언제든지 PullRequest 또는 댓글 환영!)</p>
<h3 id="구현하기-컨트롤러에-AOP-셋팅"><a href="#구현하기-컨트롤러에-AOP-셋팅" class="headerlink" title="# 구현하기 - 컨트롤러에 AOP 셋팅"></a># 구현하기 - 컨트롤러에 AOP 셋팅</h3><p>이제 Request 의 params 를 한곳에서 로깅할 차례이다. 물론 위에서 만든 필터에서 로깅을 해도 되지만 필터에 로직이 들어가는 것보다 별도의 로직에서 처리하는게 맞다고 생각되어 분리를 하였다. (관심사의 분리)<br>AOP를 활용하여 다음과 같이 로직을 작성하였다. 아래 로직은 이해하기에 큰 어려움은 없을것 같지만 주석으로 설명을 하겠다.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggerAspect</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Pointcut</span>(<span class="string">"execution(* com.taetaetae..*Controller.*(..))"</span>) <span class="comment">// 이런 패턴이 실행될 경우 수행</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loggerPointCut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Around</span>(<span class="string">"loggerPointCut()"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">methodLogger</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Object result = proceedingJoinPoint.proceed();</span><br><span class="line">			HttpServletRequest request = ((ServletRequestAttributes)RequestContextHolder.getRequestAttributes()).getRequest(); <span class="comment">// request 정보를 가져온다.</span></span><br><span class="line"></span><br><span class="line">			String controllerName = proceedingJoinPoint.getSignature().getDeclaringType().getSimpleName();</span><br><span class="line">			String methodName = proceedingJoinPoint.getSignature().getName();</span><br><span class="line"></span><br><span class="line">			Map&lt;String, Object&gt; params = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				params.put(<span class="string">"controller"</span>, controllerName);</span><br><span class="line">				params.put(<span class="string">"method"</span>, methodName);</span><br><span class="line">				params.put(<span class="string">"params"</span>, getParams(request));</span><br><span class="line">				params.put(<span class="string">"log_time"</span>, <span class="keyword">new</span> Date());</span><br><span class="line">				params.put(<span class="string">"request_uri"</span>, request.getRequestURI());</span><br><span class="line">				params.put(<span class="string">"http_method"</span>, request.getMethod());</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				log.error(<span class="string">"LoggerAspect error"</span>, e);</span><br><span class="line">			&#125;</span><br><span class="line">			log.info(<span class="string">"params : &#123;&#125;"</span>, params); <span class="comment">// param에 담긴 정보들을 한번에 로깅한다.</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">			<span class="keyword">throw</span> throwable;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * request 에 담긴 정보를 JSONObject 형태로 반환한다.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> JSONObject <span class="title">getParams</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">		JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">		Enumeration&lt;String&gt; params = request.getParameterNames();</span><br><span class="line">		<span class="keyword">while</span> (params.hasMoreElements()) &#123;</span><br><span class="line">			String param = params.nextElement();</span><br><span class="line">			String replaceParam = param.replaceAll(<span class="string">"\\."</span>, <span class="string">"-"</span>);</span><br><span class="line">			jsonObject.put(replaceParam, request.getParameter(param));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> jsonObject;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>위 코드에서는 단순히 console log를 찍었지만 필자가 운영하고 있는 어드민 툴에서는 Request 정보를 Elasticsearch 에 인덱싱하고 이를 키바나에서 보다 쉽게 조회 및 모니터링이 가능하도록 구현하였다. 로깅을 어떤식으로 남길지, 로깅이 아닌 특정 상황에서 알림을 보낸다거나 등등 이 부분은 실제 구현시에 상황에 맞춰서 만들면 될 것 같다.<br>또한 <code>Pointcut</code> 부분을 다르게 활용하여 위에서 이야기한 요구사항의 3번 (URL 중 특정 패턴으로 들어오는 요청은 다른 방식으로 로깅을 하거나, 로깅에서 제외할 수 있어야 한다.) 를 해결할 수 있다.<br>아참, AOP의 개념을 좀더 알고 싶다면 jojoldu 님의 블로그 포스팅을 추천한다. <a href="https://jojoldu.tistory.com/71" target="_blank" rel="noopener">https://jojoldu.tistory.com/71</a></p>
<p>그래서 아래처럼 테스트를 해보면 GET 이던 POST 이던 로깅이 되는것을 확인할수 있다.<br><div class="figure " style="width:;"><a class="fancybox" href="test.jpg" title="더 이쁘게 로깅을 하는건 자유!" data-caption="더 이쁘게 로깅을 하는건 자유!" data-fancybox="default"><img class="fig-img" src="test.jpg" alt="더 이쁘게 로깅을 하는건 자유!"><span class="image-caption">더 이쁘게 로깅을 하는건 자유!</span></a><span class="caption">더 이쁘게 로깅을 하는건 자유!</span></div><div style="clear:both;"></div></p>
<h3 id="마치며"><a href="#마치며" class="headerlink" title="# 마치며"></a># 마치며</h3><p>사실 이 로직을 만들게 된 계기는 팀원중에 한분이 “GET 의 파라미터는 로깅이 되는데 POST 의 파라미터는 로깅이 안되요” 라는 말에 투우사 앞에 있는 황소마냥 찾아보다 만들게 되었다. 참고로 이 부분은 하나의 <code>무기</code>가 될것 같아 github에 공개를 하였고 위에서 적었던 요구사항보다 더 좋은 내용이 있다면 언제든지 PullRequest 를 날려주기를 바란다. Spring Boot 환경에서 Filter를 추가하며 구성하였다.<br><a href="https://github.com/taetaetae/request_logging" target="_blank" rel="noopener">https://github.com/taetaetae/request_logging</a><br>필터와 인터셉터, AOP 등 평소 자주 사용하지 않은 (이미 누군가 다 만들어 둔) 부분을 만지면서 다시한번 Spring의 주요 개념을 숙지하는데 도움이 되었던 경험으로 남을 것 같다.</p>

            

        </div>
    </div>
    <style>.bmc-button img{width: 27px !important;margin-bottom: 1px !important;box-shadow: none !important;border: none !important;vertical-align: middle !important;}.bmc-button{line-height: 36px !important;height:37px !important;text-decoration: none !important;display:inline-flex !important;color:#000000 !important;background-color:#FFDD00 !important;border-radius: 3px !important;border: 1px solid transparent !important;padding: 1px 9px !important;font-size: 22px !important;letter-spacing: 0.6px !important;box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;margin: 0 auto !important;font-family:'Cookie', cursive !important;-webkit-box-sizing: border-box !important;box-sizing: border-box !important;-o-transition: 0.3s all linear !important;-webkit-transition: 0.3s all linear !important;-moz-transition: 0.3s all linear !important;-ms-transition: 0.3s all linear !important;transition: 0.3s all linear !important;}.bmc-button:hover, .bmc-button:active, .bmc-button:focus {-webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;text-decoration: none !important;box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;opacity: 0.85 !important;color:#000000 !important;}</style><link href="https://fonts.googleapis.com/css?family=Cookie" rel="stylesheet"><center><br><a class="bmc-button" target="_blank" href="https://www.buymeacoffee.com/taetaetae"><img src="https://www.buymeacoffee.com/assets/img/BMC-btn-logo.svg" alt="Buy me a coffee"><span style="margin-left:5px">Buy me a coffee</span></a>
    <!--<br><a href="http://www.naver.com"><img src="https://i.imgur.com/ietEvly.png" style="height:46px"></a>-->
    </center>
    <div id="post-footer" class="post-footer main-content-wrap">
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- blog -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-5788330009690816"
     data-ad-slot="9180895229"
     data-ad-format="auto"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">TAGGED IN</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/AOP/">AOP</a> <a class="tag tag--primary tag--small t-link" href="/tags/Filter/">Filter</a> <a class="tag tag--primary tag--small t-link" href="/tags/HttpServletRequestWrapper/">HttpServletRequestWrapper</a> <a class="tag tag--primary tag--small t-link" href="/tags/logging/">logging</a> <a class="tag tag--primary tag--small t-link" href="/tags/spring/">spring</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/07/07/review-first-half-2019/" data-tooltip="2019 상반기 리뷰 (feat. 글또)" aria-label="PREVIOUS: 2019 상반기 리뷰 (feat. 글또)">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/05/19/d-light-togetherthon-2019/" data-tooltip="D.light 투게더톤 참가후기" aria-label="NEXT: D.light 투게더톤 참가후기">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://taetaetae.github.io/2019/06/30/controller-common-logging/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://taetaetae.github.io/2019/06/30/controller-common-logging/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://taetaetae.github.io/2019/06/30/controller-common-logging/" title="Share on Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                
        <!--  utteranc comment -->
        
        <script src="https://utteranc.es/client.js"
                repo="taetaetae/blog-comment"
                issue-term="pathname"
                label="Comment"
                theme="github-light"
                crossorigin="anonymous"
                async>
        </script>
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 taetaetae. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/07/07/review-first-half-2019/" data-tooltip="2019 상반기 리뷰 (feat. 글또)" aria-label="PREVIOUS: 2019 상반기 리뷰 (feat. 글또)">
                
                    <i class="fa fa-angle-left" aria-hidden="true"></i>
                    <span class="hide-xs hide-sm text-small icon-ml">PREVIOUS</span>
                </a>
            </li>
            <li class="post-action">
                
                    
                    <a class="post-action-btn btn btn--default tooltip--top" href="/2019/05/19/d-light-togetherthon-2019/" data-tooltip="D.light 투게더톤 참가후기" aria-label="NEXT: D.light 투게더톤 참가후기">
                
                    <span class="hide-xs hide-sm text-small icon-mr">NEXT</span>
                    <i class="fa fa-angle-right" aria-hidden="true"></i>
                </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions" aria-label="Share this post">
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://taetaetae.github.io/2019/06/30/controller-common-logging/" title="Share on Facebook">
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://twitter.com/intent/tweet?text=https://taetaetae.github.io/2019/06/30/controller-common-logging/" title="Share on Twitter">
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a class="post-action-btn btn btn--default" target="new" href="https://plus.google.com/share?url=https://taetaetae.github.io/2019/06/30/controller-common-logging/" title="Share on Google+">
                    <i class="fab fa-google-plus" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#" aria-label="Back to top">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                <div id="share-options-bar" class="share-options-bar" data-behavior="5">
    <i id="btn-close-shareoptions" class="fa fa-times"></i>
    <ul class="share-options">
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://taetaetae.github.io/2019/06/30/controller-common-logging/">
                    <i class="fab fa-facebook" aria-hidden="true"></i><span>Share on Facebook</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://twitter.com/intent/tweet?text=https://taetaetae.github.io/2019/06/30/controller-common-logging/">
                    <i class="fab fa-twitter" aria-hidden="true"></i><span>Share on Twitter</span>
                </a>
            </li>
        
            
            
            <li class="share-option">
                <a class="share-option-btn" target="new" href="https://plus.google.com/share?url=https://taetaetae.github.io/2019/06/30/controller-common-logging/">
                    <i class="fab fa-google-plus" aria-hidden="true"></i><span>Share on Google+</span>
                </a>
            </li>
        
    </ul>
</div>

            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/assets/images/profile.jpg" alt="Author&#39;s picture"/>
        
            <h4 id="about-card-name">taetaetae</h4>
        
            <div id="about-card-bio"><p>Programmer</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Naver Corp.</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker"></i>
                <br/>
                korea
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/assets/images/cover_2.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.fancybox.js"></script>
<script src="/assets/js/thumbs.js"></script>
<script src="/assets/js/tranquilpeak.js"></script>
<!--SCRIPTS END-->

    



    </body>
</html>
